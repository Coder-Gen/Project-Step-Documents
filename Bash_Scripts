#!/bin/bash

NAMESPACE="default"
SERVICE_NAME="clusterpulse-service"
LOCAL_PORT=8080
REMOTE_PORT=80
LOG_FILE="/tmp/port-forward.log"

echo "$(date) Starting persistent port-forward loop for $SERVICE_NAME ($LOCAL_PORT -> $REMOTE_PORT)..."

start_port_forward() {
  kubectl port-forward svc/"$SERVICE_NAME" "$LOCAL_PORT":"$REMOTE_PORT" -n "$NAMESPACE" >> "$LOG_FILE" 2>&1
  return $?
}

while true; do
  start_port_forward
  EXIT_CODE=$?

  if [ $EXIT_CODE -ne 0 ]; then
    echo "$(date) Port-forward failed with exit code $EXIT_CODE. Retrying in 5 seconds..." >> "$LOG_FILE"
    sleep 5
  else
    echo "$(date) Port-forward exited cleanly. Not retrying." >> "$LOG_FILE"
    break
  fi
done

